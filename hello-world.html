<!DOCTYPE html>
<html>
<head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        #kpiTable {
            font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }
        #kpiTable td, #kpiTable th {
            border: 1px solid #ddd;
            padding: 8px;
        }       
        #kpiTable th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            background-color: #4CAF50;
            color: white;
        }
        #kpiTable tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        i {
            margin-left: 0.75em;
        }
        .inline {
            margin-top: 0;
            margin-bottom: 0;
            margin-left: 0.3em;
            display: -webkit-inline-box;
            font-size: 10px;
        }
        .red {
            color: red;
        }
        .yellow {
            color: #FFBF40;
        }
        .green {
            color: #4CAF50;
        }
    </style>
	<script src="lib/VSS.SDK.min.js"></script>
    <script type="text/javascript">
        VSS.init({
            explicitNotifyLoaded: true,
			usePlatformStyles: true
        });

               
        VSS.require("TFS/Dashboards/WidgetHelpers", function (WidgetHelpers) {
			WidgetHelpers.IncludeWidgetStyles();
            VSS.register("HelloWorldWidgettttttttt", function () {                
                return {
                    load: function (widgetSettings) {
                        var $title = $('h2.title');
                        $title.text('KPI Table');
                        return WidgetHelpers.WidgetStatusHelper.Success();
                    }
                }
            });
            VSS.notifyLoadSucceeded();
        });

        // Get data service
        VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
            // Get all document under the collection
            dataService.getDocuments("MyCollection2").then(function(docs) {
                console.log(docs);
            });
        });
       


        VSS.getService(VSS.ServiceIds.ExtensionData)
        // the callback on the next line returns a promise, which the JavaScript engine will follow, so you don't need to nest the next `then`
            .then((dataService) => dataService.getDocuments('MyCollection2'))
            .then((docs) => {
                // keep a reference to the element instead of searching for it in each loop.
                const table = document.getElementById("kpiTable");

                // `for...of` is a simpler way to iterate over a collection
                for (const doc of docs) {
                    var row = table.insertRow(1);
                    var KPIs = row.insertCell(0);
                    var actual = row.insertCell(1);
                    var potential = row.insertCell(2);
                    var goalPercent = row.insertCell(3);
                    var actualPercent = row.insertCell(4);
                    KPIs.innerHTML = doc.name;
                    actual.innerHTML = doc.actual;
                    potential.innerHTML = doc.potential;
                    goalPercent.innerHTML = doc.goal + " %";
                    actualPercent.innerHTML = ((doc.actual / doc.potential) * 100).toFixed(2) + " %";

                    // diffElement = document.createElement("p");

                    difference = (((doc.actual / doc.potential) * 100).toFixed(2) - doc.goal).toFixed(2)
                    console.log('diff and goal', parseFloat(difference), parseFloat(doc.goal))
                       
                    const diffElem = document.createElement("p");
                    diffElem.classList.add("inline");
                    diffElem.appendChild(document.createTextNode(` (${difference} %)`));
                    diffElem.classList.add
                    

                    console.log(diffElem)

                    if (parseFloat(difference) < -10) {
                        diffElem.classList.add("red");
                        actualPercent.appendChild(diffElem)
                    } else if (-10 <= parseFloat(difference) && parseFloat(difference) <= 10) {
                        diffElem.classList.add("yellow");
                        actualPercent.appendChild(diffElem)
                    } else {
                        diffElem.classList.add("green");
                        actualPercent.appendChild(diffElem)
                    }


                }
            });
            function sortTable(n) {
                var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
                table = document.getElementById("kpiTable");
                switching = true;

                //Set the sorting direction to ascending:
                dir = "asc"; 

                /*Make a loop that will continue until
                no switching has been done:*/
                while (switching) {
                    //start by saying: no switching is done:
                    switching = false;
                    rows = table.rows;
                    
                    /*Loop through all table rows (except the
                    first, which contains table headers):*/
                    for (i = 1; i < (rows.length - 1); i++) {
                        //start by saying there should be no switching:
                        shouldSwitch = false;
                        /*Get the two elements you want to compare,
                        one from current row and one from the next:*/
                        x = rows[i].getElementsByTagName("TD")[n];
                        y = rows[i + 1].getElementsByTagName("TD")[n];
                        /*check if the two rows should switch place,
                        based on the direction, asc or desc:*/
                        if (dir == "asc") {
                            if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                                    //if so, mark as a switch and break the loop:
                                    shouldSwitch= true;
                                    break;
                            }
                        } else if (dir == "desc") {
                                if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                                    //if so, mark as a switch and break the loop:
                                    shouldSwitch = true;
                                    break;
                                }
                            }
                    }
                    if (shouldSwitch) {
                        /*If a switch has been marked, make the switch
                        and mark that a switch has been done:*/
                        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                        switching = true;
                        //Each time a switch is done, increase this count by 1:
                        switchcount ++;      
                    } else {
                        /*If no switching has been done AND the direction is "asc",
                        set the direction to "desc" and run the while loop again.*/
                        if (switchcount == 0 && dir == "asc") {
                            dir = "desc";
                            switching = true;
                        }
                    }
                }
            }
    </script>

</head>
<body>
	<div class="widget" style="overflow: auto">
        <h2 class="title"></h1>
            <table id="kpiTable">
                <tr>
                  <th onclick="sortTable(0)">KPIs<i class="fa fa-sort"></i></th>
                  <th onclick="sortTable(1)">Actual<i class="fa fa-sort"></i></th>
                  <th onclick="sortTable(2)">Potential<i class="fa fa-sort"></i></th>
                  <th onclick="sortTable(3)">Goal %<i class="fa fa-sort"></i></th>
                  <th onclick="sortTable(4)">Actual %<i class="fa fa-sort"></i></th>
                </tr>
              </table>
	</div>
</body>
</html>