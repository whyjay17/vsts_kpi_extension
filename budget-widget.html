<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="lib/VSS.SDK.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="css/chart.css">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <style>

        </style>
        <script src="https://d3js.org/d3.v5.min.js"></script>
    </head>
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-1">
                <h2 id="prev_button"><i class="fas fa-chevron-circle-left vertical-center"></i></h2>
            </div>
            <div class="col-sm-10">
                <div class="row">
                    <div class="col-sm-7">
                        <div>
                            <p><h4 id="epic-name">Name</h4></p>
                        </div>
                        <div class="value-box">
                            <div><i id="blue" class="fas fa-square"></i><p
                                class="value-title" 
                                style="margin-top: 4rem; margin-bottom: 0em; display: inline-block;">
                                Original Estimate
                            </p><p id="orig-value"></p>
                        </div>
                            <div><i id="orange" class="fas fa-square"></i><p class="value-title" style="margin-bottom: 0em; display: inline-block;">Latest Estimate</p><p id="le-value"></p></div>
                            <div><i id="green" class="fas fa-square"></i><p class="value-title" style="margin-bottom: 0em; display: inline-block;">Cost-to-Date</p><p id="ctd-value"></p></div>
                        </div>
                    </div>
                    <div class="col-sm-3">
                        <div class="max-height">
                            <center>
                                <div id="chart"></div>
                            </center>
                        </div> 
                    </div>
                </div>
            </div>
            <div class="col-sm-1">
                <h2 id="next_button"><i class="fas fa-chevron-circle-right vertical-center"></i></h2>
            </div>
        </div>
    </div>
</html>
        <script type="text/javascript">

                VSS.init({
                    explicitNotifyLoaded: true,
                    usePlatformStyles: true
                });
                    
                VSS.require("TFS/Dashboards/WidgetHelpers", function (WidgetHelpers) {
                    WidgetHelpers.IncludeWidgetStyles();
                    VSS.register("budget-bargraph-widget", function () {                
                        return {
                            load: function (widgetSettings) {
                                var $title = $('h2.title');
                                $title.text('KPI Table');
                                return WidgetHelpers.WidgetStatusHelper.Success();
                            }
                        }
                    });
                    VSS.notifyLoadSucceeded();
                });

                // Sets unique data storage name for each project
                function setDBName() {
                    return new Promise(function(resolve, reject) {
                            VSS.ready(function(){
                                let web = VSS.getWebContext();
                                resolve(web);
                            })
                    })
                }

                let dataObj = [];
                var i = 0;

                var formatter = new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 0,
                });

                setDBName()
                    .then(function(res) {
                        // Gets the Web Context Info: Like Project Name
                        const collectionName = `${res.project.name}_budget_test`;

                        // Need an async function to assign doc values to object correctly
                        function asyncItemAssignment(collectionName) {

                            console.log(collectionName)
                            return new Promise(function(resolve, reject) {
                                // Get data service and display
                                VSS.getService(VSS.ServiceIds.ExtensionData)
                                    // the callback on the next line returns x` promise, which the JavaScript engine will follow, so you don't need to nest the next `then`
                                    .then((dataService) => dataService.getDocuments(collectionName))
                                    .then((docs) => {   
                                        resolve(docs);
                                    })
                            });
                        }

                        asyncItemAssignment(collectionName)
                            .then(function(docs) {

                                    // keep a reference to the element instead of searching for it in each loop.
                                    for (let doc of docs) {
                                        dataObj.push({
                                            name: doc.name,
                                            orig: doc.orig,
                                            le: doc.le,
                                            ctd: doc.ctd,
                                            start: doc.start,
                                            end: doc.end,
                                        })
                                    }
                                    console.log(dataObj)

                                    // Sort by most recent end-date
                                    function compareDate(a,b) {
                                        if (a.end < b.end)
                                            return -1;
                                        if (a.end > b.end)
                                            return 1;
                                        return 0;
                                    }

                                    dataObj.sort(compareDate);

                                    document.getElementById('epic-name').textContent = dataObj[0].name; 
                                    document.getElementById('orig-value').textContent = formatter.format(dataObj[i].orig);
                                    document.getElementById('ctd-value').textContent = formatter.format(dataObj[i].ctd);
                                    document.getElementById('le-value').textContent = formatter.format(dataObj[i].le);
                                    createBar(dataObj[0])

                                    // initial value
                                    
                                    document.getElementById('prev_button').addEventListener(
                                        'click', // we want to listen for a click
                                        function (e) { // the e here is the event itself
                                            prevItem();
                                            document.getElementById('epic-name').textContent = dataObj[i].name;
                                            document.getElementById('orig-value').textContent = formatter.format(dataObj[i].orig);
                                            document.getElementById('ctd-value').textContent = formatter.format(dataObj[i].ctd);
                                            document.getElementById('le-value').textContent = formatter.format(dataObj[i].le);
                                            createBar(dataObj[i])
                                        }
                                    );
                                    
                                    document.getElementById('next_button').addEventListener(
                                        'click', // we want to listen for a click
                                        function (e) { // the e here is the event itself
                                            nextItem();
                                            document.getElementById('epic-name').textContent = dataObj[i].name;
                                            document.getElementById('orig-value').textContent = formatter.format(dataObj[i].orig);
                                            document.getElementById('ctd-value').textContent = formatter.format(dataObj[i].ctd);
                                            document.getElementById('le-value').textContent = formatter.format(dataObj[i].le);
                                            createBar(dataObj[i])
                                        }
                                    );
                            })
                            .catch(function(err){
                                console.log(err)
                            })
                        })
                        .catch(function(err){
                            console.log(err)
                        })
      
                function nextItem() {
                    i = i + 1; // increase i by one
                    i = i % dataObj.length; // if we've gone too high, start from `0` again
                    console.log(i)
                    return dataObj[i]; // give us back the item of where we are now
                }

                function prevItem() {
                    if (i === 0) { // i would become 0
                        i = dataObj.length; // so put it at the other end of the array
                    }
                    i = i - 1; // decrease by one
                    console.log(i)
                    return dataObj[i]; // give us back the item of where we are now
                }

                function createBar(dat) {

                    d3.select("svg").remove();

                    let obj = []
                    obj[0] = dat

                    // Create variable for the SVG
                    var svg = d3.select("#chart").append("svg")
                        .attr("height", '100em')
                        .attr("width", 225);


                    var tooltip = d3.select("body").append("div").attr("class", "toolTip");

                    // Select, append to SVG, and add attributes to rectangles for bar chart
                    svg.selectAll(".bar")
                        .data(obj)
                        .enter().append("rect")
                            .attr("class", 'bar')
                            .attr("height", function(d, i) { return 280 * (parseInt(obj[0].orig) / (parseInt(obj[0].orig) + parseInt(obj[0].le) + parseInt(obj[0].ctd)))})
                            .attr("width", 60)
                            .attr("x", function(d, i) {return (i * 80)})
                            .attr("y", function(d, i) {return 280 - (280 * (parseInt(obj[0].orig) / (parseInt(obj[0].orig) + parseInt(obj[0].le) + parseInt(obj[0].ctd))))})    
                            .on("mousemove", function(d){
                                tooltip
                                .style("left", d3.event.pageX - 50 + "px")
                                .style("top", d3.event.pageY - 70 + "px")
                                .style("display", "inline-block")
                                .html(formatter.format(obj[0].orig));
                            })
                            .on("mouseout", function(d){ tooltip.style("display", "none");});

                    svg.selectAll(".bar2")
                        .data(obj)
                        .enter().append("rect")
                            .attr("class", 'bar2')
                            .attr("height", function(d, i) { return 280 * (parseInt(obj[0].le) / (parseInt(obj[0].orig) + parseInt(obj[0].le) + parseInt(obj[0].ctd)))})
                            .attr("width", 60)
                            .attr("x", function(d, i) {return (i * 80) + 60})
                            .attr("y", function(d, i) {return 280 - (280 * (parseInt(obj[0].le) / (parseInt(obj[0].orig) + parseInt(obj[0].le) + parseInt(obj[0].ctd))))})      
                            .on("mousemove", function(d){
                                tooltip
                                .style("left", d3.event.pageX - 50 + "px")
                                .style("top", d3.event.pageY - 70 + "px")
                                .style("display", "inline-block")
                                .html(formatter.format(obj[0].le));
                            })
                            .on("mouseout", function(d){ tooltip.style("display", "none");});

                    svg.selectAll(".bar3")
                        .data(obj)
                        .enter().append("rect")
                            .attr("class", 'bar3')
                            .attr("height", function(d, i) { return 280 * (parseInt(obj[0].ctd) / (parseInt(obj[0].orig) + parseInt(obj[0].le) + parseInt(obj[0].ctd)))})
                            .attr("width", 60)
                            .attr("x", function(d, i) {return (i * 80) + (2 * 60)})
                            .attr("y", function(d, i) {return 280 - (280 * (parseInt(obj[0].ctd) / (parseInt(obj[0].orig) + parseInt(obj[0].le) + parseInt(obj[0].ctd))))})     
                            .on("mousemove", function(d){
                                tooltip
                                .style("left", d3.event.pageX - 50 + "px")
                                .style("top", d3.event.pageY - 70 + "px")
                                .style("display", "inline-block")
                                .html(formatter.format(obj[0].ctd));
                            })
                            .on("mouseout", function(d){ tooltip.style("display", "none");});


                    // Select, append to SVG, and add attributes to text

                }
        </script>
