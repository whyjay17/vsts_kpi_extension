<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="lib/VSS.SDK.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="css/chart.css">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <style>
            .vertical-center, .value-box {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
            }
            .container-fluid {
                height: 100%;
            }
            .row {
                height: 100%;
            }
            i {
                color: silver;
            }
            i:hover {
                color: #333;
            }
            p {
                margin-top: 1em;
                margin-bottom: 1em;
            }
            .max-height, center {
                height: 100%;
            }
            #chart {
                height: 100%;
            }
            svg {
                overflow: auto;
                margin-top: 4.0em;
            }
        </style>
        <script src="https://d3js.org/d3.v5.min.js"></script>
    </head>
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-1">
                    <h2 id="prev_button"><i class="fas fa-chevron-left vertical-center"></i></h2>
                </div>
                <div class="col-sm-10">
                    <div class="row">
                        <div class="col-sm-7">
                            <div>
                                <p><h4 id="epic-name">Name</h4></p>
                            </div>
                            <div class="value-box">
                                <div><p>Actual:</p><p id="actual-value"></p></div>
                                <div><p>Projected:</p><p id="projected-value"></p></div>
                                <div><p>Latest:</p><p id="latest-value"></p></div>
                            </div>
                        </div>
                        <div class="col-sm-5">
                            <div class="max-height">
                                <center>
                                    <div id="chart"></div>
                                </center>
                            </div> 
                        </div>
                    </div>


                </div>
                <div class="col-sm-1">
                    <h2 id="next_button"><i class="fas fa-chevron-right vertical-center"></i></h2>
                </div>
            </div>
        </div>
</html>
        <script type="text/javascript">

                VSS.init({
                    explicitNotifyLoaded: true,
                    usePlatformStyles: true
                });
                    
                VSS.require("TFS/Dashboards/WidgetHelpers", function (WidgetHelpers) {
                    WidgetHelpers.IncludeWidgetStyles();
                    VSS.register("budget-bargraph-widget", function () {                
                        return {
                            load: function (widgetSettings) {
                                var $title = $('h2.title');
                                $title.text('KPI Table');
                                return WidgetHelpers.WidgetStatusHelper.Success();
                            }
                        }
                    });
                    VSS.notifyLoadSucceeded();
                });

                let dataObj = [];

                function delay() {
                    return new Promise(function(resolve, reject) {
                         // Get data service and display
                    VSS.getService(VSS.ServiceIds.ExtensionData)
                        // the callback on the next line returns x` promise, which the JavaScript engine will follow, so you don't need to nest the next `then`
                        .then((dataService) => dataService.getDocuments('MyCollection3'))
                        .then((docs) => {   
                            resolve(docs);
                        })
                    });
                }

                delay()
                    .then(function(docs) {

                            // keep a reference to the element instead of searching for it in each loop.
                            console.log('promised', docs)

                            for (let doc of docs) {
                                dataObj.push({
                                    name: doc.name,
                                    projected: doc.projected,
                                    actual: doc.actual,
                                    le: doc.le,
                                    start: doc.start,
                                    end: doc.end,
                                })
                            }
                            console.log(dataObj)

                            function compareDate(a,b) {
                                if (a.end < b.end)
                                    return -1;
                                if (a.end > b.end)
                                    return 1;
                                return 0;
                            }

                            dataObj.sort(compareDate);

                            console.log('sorted', dataObj)

                            document.getElementById('epic-name').textContent = dataObj[0].name; 
                            document.getElementById('actual-value').textContent = dataObj[0].actual;
                            document.getElementById('projected-value').textContent = dataObj[0].projected;
                            document.getElementById('latest-value').textContent = dataObj[0].le;
                            createBar(dataObj[0])

                            // initial value
                            
                            document.getElementById('prev_button').addEventListener(
                                'click', // we want to listen for a click
                                function (e) { // the e here is the event itself
                                    prevItem();
                                    document.getElementById('epic-name').textContent = dataObj[i].name;
                                    document.getElementById('actual-value').textContent = dataObj[i].actual;
                                    document.getElementById('projected-value').textContent = dataObj[i].projected;
                                    document.getElementById('latest-value').textContent = dataObj[i].le;
                                    createBar(dataObj[i])
                                }
                            );
                            
                            document.getElementById('next_button').addEventListener(
                                'click', // we want to listen for a click
                                function (e) { // the e here is the event itself
                                    nextItem();
                                    document.getElementById('epic-name').textContent = dataObj[i].name;
                                    document.getElementById('actual-value').textContent = dataObj[i].actual;
                                    document.getElementById('projected-value').textContent = dataObj[i].projected;
                                    document.getElementById('latest-value').textContent = dataObj[i].le;
                                    createBar(dataObj[i])
                                }
                            );
                      

                    })
                    .catch(function(err){
                        console.log(err)
                    })

                // Get data service and display
                VSS.getService(VSS.ServiceIds.ExtensionData)
                    // the callback on the next line returns x` promise, which the JavaScript engine will follow, so you don't need to nest the next `then`
                    .then((dataService) => dataService.getDocuments('MyCollection3'))
                    .then((docs) => {   

                        let promiseArr = []
                        // keep a reference to the element instead of searching for it in each loop.
                        console.log(docs)

                        for (let doc of docs) {
                            promiseArr.push({
                                name: doc.name,
                                projected: doc.projected,
                                actual: doc.actual,
                                le: doc.le,
                            })
                        }
                        return Promise.all(promiseArr)
                        console.log(promiseArr)
                    })
                    .then(data => {
                        dataObj = data;
                    })
      

                var i = 0;

                console.log('fin', dataObj)
                function nextItem() {
                    i = i + 1; // increase i by one
                    i = i % dataObj.length; // if we've gone too high, start from `0` again
                    console.log(i)
                    return dataObj[i]; // give us back the item of where we are now
                }

                function prevItem() {
                    if (i === 0) { // i would become 0
                        i = dataObj.length; // so put it at the other end of the array
                    }
                    i = i - 1; // decrease by one
                    console.log(i)
                    return dataObj[i]; // give us back the item of where we are now
                }

                function createBar(dat) {

                    d3.select("svg").remove();

                    let obj = []
                    obj[0] = dat

                    let biggesteClass = '';
                    let biggestVal = 0;
                    let secondClass = '';
                    let secondVal = 0;
                    let thirdClass = '';
                    let thirdVal = 0;

                    // Create variable for the SVG
                    var svg = d3.select("#chart").append("svg")
                        .attr("height", '110em')
                        .attr("width", '110em');

                    if (parseInt(obj[0].actual) > parseInt(obj[0].projected) && parseInt(obj[0].projected) > parseInt(obj[0].le)) {
                        biggesteClass = 'bar';
                        biggestVal = obj[0].actual;
                        secondClass ='bar2';
                        secondVal = obj[0].projected;
                        thirdClass ='bar3';
                        thirdVal = obj[0].le;
                    } else if (parseInt(obj[0].actual) > parseInt(obj[0].le) && parseInt(obj[0].le) > parseInt(obj[0].projected)) {
                        biggesteClass = 'bar';
                        biggestVal = obj[0].actual;
                        secondClass = 'bar3';
                        secondVal = obj[0].le;
                        thirdClass ='bar2';
                        thirdVal = obj[0].projected;
                    } else if (parseInt(obj[0].projected) > parseInt(obj[0].actual) && parseInt(obj[0].actual) > parseInt(obj[0].le)) {
                        biggesteClass = 'bar2';
                        biggestVal = obj[0].projected;
                        secondClass ='bar';
                        secondVal = obj[0].actual;
                        thirdClass ='bar3';
                        thirdVal = obj[0].le;
                    }  else if (parseInt(obj[0].projected) > parseInt(obj[0].le) && parseInt(obj[0].le) > parseInt(obj[0].actual)) {
                        biggesteClass = 'bar2';
                        biggestVal = obj[0].projected;
                        secondClass ='bar3';
                        secondVal = obj[0].le;
                        thirdClass ='bar';
                        thirdVal = parseInt(obj[0].actual);
                    } else if (parseInt(obj[0].le) > parseInt(obj[0].actual) && parseInt(obj[0].actual) > parseInt(obj[0].projected)) {
                        biggesteClass = 'bar3';
                        biggestVal = obj[0].le;
                        secondClass ='bar';
                        secondVal = obj[0].actual;
                        thirdClass ='bar2';
                        thirdVal = obj[0].projected;
                    } else {
                        biggesteClass = 'bar3';
                        biggestVal = obj[0].le;
                        secondClass ='bar2';
                        secondVal = obj[0].projected;
                        thirdClass ='bar';
                        thirdVal = obj[0].actual;
                    }

                    // Select, append to SVG, and add attributes to rectangles for bar chart
                    svg.selectAll("." + biggesteClass)
                        .data(obj)
                        .enter().append("rect")
                            .attr("class", biggesteClass)
                            .attr("height", function(d, i) {return (biggestVal * 10)})
                            .attr("width","100")
                            .attr("x", function(d, i) {return (i * 80) + 25})
                            .attr("y", function(d, i) {return 280 - (biggestVal * 10)});    

                    svg.selectAll("." + secondClass)
                        .data(obj)
                        .enter().append("rect")
                            .attr("class", secondClass)
                            .attr("height", function(d, i) {return (secondVal * 10)})
                            .attr("width","100")
                            .attr("x", function(d, i) {return (i * 80) + 25})
                            .attr("y", function(d, i) {return 280 - (secondVal * 10)}); 

                    svg.selectAll("." + thirdClass)
                        .data(obj)
                        .enter().append("rect")
                            .attr("class", thirdClass)
                            .attr("height", function(d, i) {return (thirdVal * 10)})
                            .attr("width","100")
                            .attr("x", function(d, i) {return (i * 80) + 25})
                            .attr("y", function(d, i) {return 280 - (thirdVal * 10)}); 


                    // Select, append to SVG, and add attributes to text
                    svg.selectAll(".text")
                        .data(obj)
                        .enter().append("text")
                        .text(function(d) {return d.actual})
                            .attr("class", "text")
                            .attr("x", function(d, i) {return 66})
                            .attr("y", function(d, i) {return 295 - (d.actual * 10)});

                    // Select, append to SVG, and add attributes to text
                    svg.selectAll(".text2")
                        .data(obj)
                        .enter().append("text")
                        .text(function(d) {return d.projected})
                            .attr("class", "text2")
                            .attr("x", function(d, i) {return 66})
                            .attr("y", function(d, i) {return 295 - (d.projected * 10)});

                    // Select, append to SVG, and add attributes to text
                    svg.selectAll(".text3")
                        .data(obj)
                        .enter().append("text")
                        .text(function(d) {return d.le})
                            .attr("class", "text3")
                            .attr("x", function(d, i) {return 66})
                            .attr("y", function(d, i) {return 295 - (d.le * 10)});
            
                }

            /*
            VSS.init({
                explicitNotifyLoaded: true,
                usePlatformStyles: true
            });
                
            VSS.require("TFS/Dashboards/WidgetHelpers", function (WidgetHelpers) {
                WidgetHelpers.IncludeWidgetStyles();
                VSS.register("budget-bargraph-widget", function () {                
                    return {
                        load: function (widgetSettings) {
                            var $title = $('h2.title');
                            $title.text('KPI Table');
                            return WidgetHelpers.WidgetStatusHelper.Success();
                        }
                    }
                });
                VSS.notifyLoadSucceeded();
            });
            // Get data service
            VSS.getService(VSS.ServiceIds.ExtensionData).then(function(dataService) {
                // Get all document under the collection
                dataService.getDocuments("MyCollection3").then(function(docs) {
                    console.log(docs);
                    var dataObj = docs

                            
                    // Create variable for the SVG
                    var svg = d3.select("body").append("svg")
                            .attr("height","100%")
                            .attr("width","100%");

                    // Select, append to SVG, and add attributes to rectangles for bar chart
                    svg.selectAll(".bar")
                        .data(dataObj)
                        .enter().append("rect")
                            .attr("class", "bar")
                            .attr("height", function(d, i) {return (d.le * 10)})
                            .attr("width","40")
                            .attr("x", function(d, i) {return (i * 60) + 25})
                            .attr("y", function(d, i) {return 400 - (d.le * 10)});

                    svg.selectAll(".bar3")
                            .data(dataObj)
                            .enter().append("rect")
                                .attr("class", "bar3")
                                .attr("height", function(d, i) {return (d.actual * 10)})
                                .attr("width","40")
                                .attr("x", function(d, i) {return (i * 60) + 25})
                                .attr("y", function(d, i) {return 400 - (d.actual * 10)});
                        

                    svg.selectAll(".bar2")
                        .data(dataObj)
                        .enter().append("rect")
                            .attr("class", "bar2")
                            .attr("height", function(d, i) {return (d.projected * 10)})
                            .attr("width","40")
                            .attr("x", function(d, i) {return (i * 60) + 25})
                            .attr("y", function(d, i) {return 400 - (d.projected * 10)});


                    // Select, append to SVG, and add attributes to text
                    svg.selectAll(".text")
                        .data(dataObj)
                        .enter().append("text")
                        .text(function(d) {return d.le})
                            .attr("class", "text")
                            .attr("x", function(d, i) {return (i * 60) + 36})
                            .attr("y", function(d, i) {return 415 - (d.le * 10)});
                });
            });
*/
//////////////////////////////
        </script>
